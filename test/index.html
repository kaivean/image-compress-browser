<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Jasmine Spec Runner v2.2.0</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link rel="stylesheet" href="../node_modules/jasmine-core/lib/jasmine-core/jasmine.css">

    <script src="../node_modules/jasmine-core/lib/jasmine-core/jasmine.js"></script>
    <script src="../node_modules/jasmine-core/lib/jasmine-core/jasmine-html.js"></script>
    <script src="../node_modules/jasmine-core/lib/jasmine-core/boot.js"></script>
    <script src="https://cdn.bootcss.com/zepto/1.2.0/zepto.min.js"></script>
    <script src="../dist/compressImage.js"></script>
    <script src="spec/mainSpec.js"></script>
</head>
<body>
    <script>
    function compressAndUploadImg(file, callback) {
        statData.name = file.name;
        statData.total = performance.now();
        compressImage(file, function (base64OrFile, width, height) {
            statData.upload = performance.now();

            console.log('base64OrFile', base64OrFile);

            var formData = new FormData();
            formData.append('tn', 'wise');
            formData.append('image', base64OrFile);

            var params = {
                url: 'https://graph.baidu.com/upload',
                type: 'POST',
                timeout: 10000, // 10s
                data: formData,
                processData: false,
                contentType: false,
                cache: false,
                success: function (res) {
                    statData.upload = performance.now() - statData.upload;
                    statData.total = performance.now() - statData.total;

                    statData.url = '';
                    if (!res.status) {
                        statData.url = res.data.url;
                    }

                    if (typeof base64OrFile == 'string') {

                        $('#after img').attr('src', 'data:image/jpeg;base64,' + base64OrFile);
                    }
                    else {
                        var URL = window.URL || window.webkitURL;
                        var url = URL.createObjectURL(base64OrFile);
                        $('#after img').attr('src', url);
                    }

                    callback(res);
                },
                error: function (xhr, errorType) {
                    statData.upload = performance.now() - statData.upload;
                    statData.total = performance.now() - statData.total;

                    if (typeof base64OrFile == 'string') {

                        $('#after img').attr('src', 'data:image/jpeg;base64,' + base64OrFile);
                    }
                    else {
                        var URL = window.URL || window.webkitURL;
                        var url = URL.createObjectURL(base64OrFile);
                        $('#after img').attr('src', url);
                    }

                    callback({
                        status: 1,
                        info: 'ajaxerror,' + errorType
                    });


                }
            };

            $.ajax(params);
        });
    }

    $('#file').on('change', function () {
        var file = $('#file')[0].files[0];
        var URL = window.URL || window.webkitURL;
        var url = URL.createObjectURL(file);
        $('#before img').attr('src', url);
    });

    function start(type,cb) {
        window.statData = {
            os: navigator.userAgent.indexOf('iPhone OS') > -1 ? 'ios': 'android',
            phone: 'vivo、qq浏览器', //'红米note, xiaoMi浏览器',
            upload: 0,
            fileTo: 0,
            toImg: 0,
            orient: 0,
            toCanvas: 0,
            rotate: 0,
            canvasOut: 0,
            total: 0
        };

        statData.type = type;
        var file = $('#file')[0].files[0];
        if (!file) {
            return alert('选择文件');
        }

        console.log('file', file);

        $('#click').html('文件信息：'+file.type + '  size: ' + file.size + '<br/>当前选择压缩方式：' + $(this).text());
        $('#status').html('上传中...');
        var t = Date.now();
        compressAndUploadImg(file,function (res) {
            $('#status').html(
                '返回状态：' + (!res.status ? '上传成功' : '上传失败') + '<br/> 耗时: ' + (Date.now()-t)
                + '<br/> 返回结果页:' + JSON.stringify(res)
            );

            // 发送统计日志
            var querys = [];
            for (var key in statData) {
                var val = statData[key] || '';
                if (val.toString().indexOf('.') > -1) {
                    try {
                        val = val.toFixed(2);
                    }
                    catch(e) {

                    }
                }
                querys.push(key + '=' + val);
            }
            (new Image()).src = '/log?' + querys.join('&');

            setTimeout(function () {
                cb();
            }, 200);
        });

        return false;
    }

    $('button.way').on('click', function () {
        start($(this).data('type'));
    });


    /**********
        压测
    */
    //
    var count = 10;
    var buttons = $('button.way');
    var total = buttons.length * count;
    var wayNum = buttons.length;

    function digui(cur) {
        if (cur > total) {
            $('#totest').text('压测:' + wayNum + '* ' + count +'次，已完成');
            return;
        }

        var wayI = (cur - 1) % wayNum;
        var type = buttons.eq(wayI).data('type');
        $('#totest').text('压测:' + wayNum + '* ' + count +'次，当前：第' + (cur) +'次，类型: ' + type);
        start(type, function () {
            cur++;
            digui(cur);
        });
    }

    $('#totest').on('click', function () {
        var file = $('#file')[0].files[0];
        if (!file) {
            return alert('选择文件');
        }
        digui(1);
    });

    // 全局错误监听
    window.addEventListener('error', function (e) {
        var error = e.error || {};
        var obj = {
            message: e.message,
            line: e.lineno || e.line,
            column: e.colno || e.column,
            stack: error.stack,
            sourceURL: e.filename || e.sourceURL
        };
        (new Image()).src = '/error?info=' + JSON.stringify(obj);
    });

    </script>
</body>
</html>
